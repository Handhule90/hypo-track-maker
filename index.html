<!-- ===== STORM-BUILDER ADD-ON ===== -->
<style>
  #stormBuilder {
    position: absolute;
    top: 70px;
    right: 10px;
    z-index: 1000;
    background: rgba(255,255,255,.9);
    padding: 8px;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,.4);
    font-size: 13px;
    width: 200px;
  }
  #stormBuilder input, #stormBuilder button {
    width: 100%;
    margin: 4px 0;
    box-sizing: border-box;
  }
</style>

<div id="stormBuilder">
  <input id="sbName" placeholder="Storm name" value="MYSTORM">
  <input id="sbStart" type="datetime-local" step="1">
  <button id="sbNew">New storm</button>
  <button id="sbExport" disabled>Export JSON</button>
  <div id="sbHint" style="font-size:11px;color:#666;margin-top:4px">
    Click “New storm”, then click map to add points.
  </div>
</div>

<script>
/* ---------- state ---------- */
let sbActive = false;          // are we currently drawing?
let sbPath = [];               // array of {lat, lon, time, speed, pressure, class}
let sbStartEpoch;              // unix seconds for first point
let sbName;                    // storm name
let sbLine;                    // leaflet polyline
let sbMarkers = L.layerGroup().addTo(map);  // reusable layer

/* ---------- helpers ---------- */
function fmtTime(epochS) {
  const d = new Date(epochS * 1000);
  return d.toISOString().replace('T',' ').slice(0,16); // yyyy-mm-dd HH:MM
}
function snap(v) { return Math.round(v * 10) / 10; } // 0.1° grid

/* ---------- UI ---------- */
const $ = id => document.getElementById(id);
$('sbStart').value = new Date().toISOString().slice(0,16); // now local

$('sbNew').onclick = () => {
  sbName = $('sbName').value.trim() || 'UNNAMED';
  sbStartEpoch = Math.floor(new Date($('sbStart').value).getTime() / 1000);
  if (!sbStartEpoch) { alert('Pick a valid start date/time'); return; }
  sbPath = [];
  sbMarkers.clearLayers();
  if (sbLine) map.removeLayer(sbLine);
  sbLine = L.polyline([], {color: '#ff7800', weight: 3}).addTo(map);
  sbActive = true;
  $('sbExport').disabled = false;
  $('sbHint').textContent = 'Click map to add points (6 h apart).';
};

$('sbExport').onclick = () => {
  if (!sbPath.length) { alert('No points added yet'); return; }
  const obj = {
    name: sbName.toUpperCase(),
    start_time: sbStartEpoch,
    path: sbPath.map(p => ({
      time: fmtTime(p.time),
      lat: p.lat,
      long: p.lon,
      speed: p.speed,
      pressure: p.pressure,
      class: p.class
    }))
  };
  const blob = new Blob([JSON.stringify([obj], null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (sbName.toLowerCase() || 'storm') + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

/* ---------- map clicks ---------- */
map.on('click', e => {
  if (!sbActive) return;
  const lat = snap(e.latlng.lat);
  const lon = snap(e.latlng.lng);
  const idx = sbPath.length;
  const epoch = sbStartEpoch + idx * 6 * 3600; // 6-hourly

  // default intensity: TD (class 1) 35 kt, 1000 hPa
  const point = {
    lat: lat,
    lon: lon,
    time: epoch,
    speed: idx ? sbPath[idx-1].speed : '35', // carry forward
    pressure: idx ? sbPath[idx-1].pressure : '1000',
    class: idx ? sbPath[idx-1].class : 1
  };

  // quick editor popup to tweak speed/pressure/class
  const popup = L.popup({autoClose: false, closeOnClick: false})
    .setLatLng(e.latlng)
    .setContent(`
      <div style="font-size:13px">
        Lat: ${lat}°<br>Lon: ${lon}°<br>
        Speed (kt): <input id="pSpeed" type="number" value="${point.speed}" min="0" max="200" step="5"><br>
        Pressure (hPa): <input id="pPres" type="number" value="${point.pressure}" min="800" max="1020"><br>
        Class:
        <select id="pClass">
          <option value="0" ${point.class===0?'selected':''}>Disturbance</option>
          <option value="1" ${point.class===1?'selected':''}>TD/TS</option>
          <option value="2" ${point.class===2?'selected':''}>Typhoon</option>
          <option value="3" ${point.class===3?'selected':''}>STY</option>
          <option value="4" ${point.class===4?'selected':''}>SuperTY</option>
          <option value="5" ${point.class===5?'selected':''}>Megatyphoon</option>
        </select><br>
        <button id="pOK">OK</button>
      </div>`)
    .openOn(map);

  document.getElementById('pOK').onclick = () => {
    point.speed = document.getElementById('pSpeed').value;
    point.pressure = document.getElementById('pPres').value;
    point.class = parseInt(document.getElementById('pClass').value);
    sbPath.push(point);
    sbLine.addLatLng([lat, lon]);
    L.marker([lat, lon], {
      icon: L.divIcon({className: 'sb-marker', html: idx||'', iconSize: [14,14]})
    }).addTo(sbMarkers);
    map.closePopup();
  };
});
</script>
<!-- ===== END STORM-BUILDER ===== -->
