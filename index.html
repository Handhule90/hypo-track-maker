<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hypo-Track Maker / Loader (long-based)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      font-size: 13px;
      width: 220px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 16px;
    }
    #panel input, #panel button, #panel select {
      width: 100%;
      margin: 6px 0;
      box-sizing: border-box;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #panel button {
      background: #3498db;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    #panel button:hover {
      background: #2980b9;
    }
    #panel button#sbExport {
      background: #27ae60;
    }
    #panel button#sbExport:hover {
      background: #219653;
    }
    #panel button#editAllBtn {
      background: #e67e22;
    }
    #panel button#editAllBtn.edit-mode {
      background: #c0392b;
    }
    #panel button#lockMapBtn {
      background: #7f8c8d;
    }
    #panel button#lockMapBtn.locked {
      background: #c0392b;
    }
    .sb-marker {
      background: #ff7800;
      color: #fff;
      border-radius: 50%;
      border: 1px solid #fff;
      text-align: center;
      line-height: 14px;
      font-size: 10px;
      font-weight: bold;
    }
    .ss-table {
      font-size: 11px;
      border-collapse: collapse;
      margin-top: 8px;
      width: 100%;
    }
    .ss-table td {
      border: 1px solid #ddd;
      padding: 3px 5px;
      background: #f9f9f9;
    }
    .ss-table tr:nth-child(even) {
      background: #f0f0f0;
    }
    #hint {
      margin-top: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 11px;
      color: #666;
    }
    .par-label {
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }
    .first-point {
      stroke: #000;
      stroke-width: 2;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <h3>Hypo-Track Maker</h3>
    <input id="file" type="file" accept=".json" multiple title="Import JSON(s)">
    <input id="sbName" placeholder="Storm name" value="MYSTORM">
    <input id="sbStart" type="datetime-local" step="1">
    <button id="sbNew">New Storm</button>
    <button id="sbExport">Export All Storms</button>
    <button id="editAllBtn">Highlight All Tracks</button>
    <button id="lockMapBtn">Lock Map</button>
    
    <div id="hint">
      <strong>How to edit storms:</strong><br>
      • <strong>Drag any point</strong> to move it<br>
      • <strong>Drag the FIRST point</strong> (bold border) to move the <u>entire storm</u><br>
      • Click any point to edit details<br>
      • Use "Lock Map" to prevent accidental panning<br><br>
      <strong>PAR:</strong> Red dashed area = Philippine Area of Responsibility
    </div>
    
    <div style="margin-top: 10px;">
      <strong>Storm Categories:</strong>
      <table class="ss-table">
        <tr><td>TD</td><td>&lt;33 kt</td></tr>
        <tr><td>TS</td><td>34-63 kt</td></tr>
        <tr><td>Cat 1</td><td>64-82 kt</td></tr>
        <tr><td>Cat 2</td><td>83-95 kt</td></tr>
        <tr><td>Cat 3</td><td>96-112 kt</td></tr>
        <tr><td>Cat 4</td><td>113-136 kt</td></tr>
        <tr><td>Cat 5</td><td>≥137 kt</td></tr>
      </table>
    </div>
  </div>

  <script>
  /* =========================================================
     1.  BASE MAP
     ========================================================= */
  const map = L.map('map').setView([15, 135], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OSM contributors'
  }).addTo(map);

  /* =========================================================
     2.  GLOBAL STATE
     ========================================================= */
  const ALL_STORMS = [];
  let ACTIVE_DRAW = null;
  let EDIT_POPUP = null;
  let PAR_LAYER = null;
  let MAP_LOCKED = false;

  /* =========================================================
     3.  MAP LOCKING
     ========================================================= */
  function toggleMapLock() {
    MAP_LOCKED = !MAP_LOCKED;
    const lockBtn = document.getElementById('lockMapBtn');
    
    if (MAP_LOCKED) {
      map.dragging.disable();
      map.touchZoom.disable();
      map.doubleClickZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      lockBtn.textContent = 'Unlock Map';
      lockBtn.classList.add('locked');
    } else {
      map.dragging.enable();
      map.touchZoom.enable();
      map.doubleClickZoom.enable();
      map.scrollWheelZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
      lockBtn.textContent = 'Lock Map';
      lockBtn.classList.remove('locked');
    }
  }

  /* =========================================================
     4.  DATA NORMALISER
     ========================================================= */
  function normalizeStormData(arr) {
    if (!Array.isArray(arr)) throw new Error("JSON must be an array of storms");
    return arr.map(storm => {
        if (!storm.path || !Array.isArray(storm.path)) return null;
        const validPath = storm.path.map(p => {
            let lat = parseFloat(p.lat ?? p.latitude);
            let long = parseFloat(p.long ?? p.lon ?? p.lng ?? p.longitude);
            if (isNaN(lat) || isNaN(long)) { console.warn("Bad point", p); return null; }
            return {
                time: p.time ?? "",
                lat: lat,
                long: long,
                speed: p.speed ?? 0,
                pressure: p.pressure ?? 1000,
                class: p.class ?? 0
            };
        }).filter(Boolean);
        if (!validPath.length) return null;
        return { name: storm.name || "UNNAMED", start_time: storm.start_time, path: validPath };
    }).filter(Boolean);
  }

  /* =========================================================
     5.  DRAW PAR
     ========================================================= */
  function drawPAR() {
    const parCoords = [[5,115],[15,115],[21,120],[25,120],[25,135],[5,135],[5,115]];
    PAR_LAYER = L.polygon(parCoords, {
      color: '#ff0000',
      weight: 2,
      fill: false,
      dashArray: '5, 5'
    }).addTo(map);
    
    L.marker([15, 125], {
      icon: L.divIcon({ className: 'par-label', html: 'PAR', iconSize: [40,20] })
    }).addTo(map);
  }
  drawPAR();

  /* =========================================================
     6.  RENDER STORM (with full editability)
     ========================================================= */
  function classColor(c){
    return ['#888','#ffd800','#ff7800','#ff3800','#c80000','#8c00ff'][c]||'#888';
  }

  function renderStorm(storm, faint = false) {
    // Remove old layer if exists
    if (storm._layer) map.removeLayer(storm._layer);

    const pts = storm.path;
    const lineCoords = pts.map(p => [p.lat, p.long]);
    const line = L.polyline(lineCoords, {
      color: classColor(pts[pts.length-1].class),
      weight: 3,
      opacity: faint ? 0.4 : 1
    });

    const dots = L.layerGroup();
    
    pts.forEach((p, i) => {
      const isStart = (i === 0);
      const radius = isStart ? 7 : 6;
      
      const m = L.circleMarker([p.lat, p.long], {
        radius: radius,
        color: classColor(p.class),
        fillColor: classColor(p.class),
        fillOpacity: 1,
        opacity: faint ? 0.4 : 1,
        draggable: true,
        className: isStart ? 'storm-point first-point' : 'storm-point'
      });

      m.stormRef = storm;
      m.ptIdx = i;

      m.on('dragend', function(e) {
        const newPos = e.target.getLatLng();
        const s = this.stormRef;
        const idx = this.ptIdx;
        const oldPos = L.latLng(s.path[idx].lat, s.path[idx].long);
        
        // If dragging the FIRST point → move entire storm
        if (idx === 0) {
          const deltaLat = newPos.lat - oldPos.lat;
          const deltaLng = newPos.lng - oldPos.lng;
          
          s.path.forEach(pt => {
            pt.lat = parseFloat((pt.lat + deltaLat).toFixed(1));
            pt.long = parseFloat((pt.long + deltaLng).toFixed(1));
          });
        } else {
          // Move just this point
          s.path[idx].lat = parseFloat(newPos.lat.toFixed(1));
          s.path[idx].long = parseFloat(newPos.lng.toFixed(1));
        }
        
        // Redraw storm
        renderStorm(s, faint);
      });

      m.on('click', function(e) {
        L.DomEvent.stopPropagation(e);
        openPointEditor(this.stormRef, this.ptIdx);
      });

      m.bindPopup(`<b>${storm.name}</b> #${i+1}<br>${p.time}<br>${p.speed} kt / ${p.pressure} hPa`);
      dots.addLayer(m);
    });

    const layer = L.layerGroup([line, dots]);
    layer.addTo(map);
    storm._layer = layer;
  }

  function redrawAll(faint = false) {
    ALL_STORMS.forEach(s => renderStorm(s, faint));
  }

  /* =========================================================
     7.  POINT EDITOR
     ========================================================= */
  function openPointEditor(storm, ptIdx) {
    const p = storm.path[ptIdx];
    let valTime = "";
    try { 
      let d = new Date(p.time);
      if(isNaN(d.getTime())) d = new Date(p.time.replace(' ', 'T')); 
      valTime = d.toISOString().slice(0,16); 
    } catch(e){}

    const html = `
      <div style="font-size:13px; max-width:250px;">
        <b>${ptIdx === 0 ? 'START POINT' : 'Edit Point'}</b><br>
        Storm name: <input id="eName" value="${storm.name}"><br>
        Date/time: <input id="eTime" type="datetime-local" value="${valTime}"><br>
        Lat: <input id="eLat" type="number" step="0.1" value="${p.lat}"><br>
        Long: <input id="eLong" type="number" step="0.1" value="${p.long}"><br>
        Speed (kt): <input id="eSpeed" type="number" min="0" max="200" value="${p.speed}"><br>
        Pressure (hPa): <input id="ePres" type="number" min="800" max="1030" value="${p.pressure}"><br>
        Class: 
        <select id="eClass">
          <option value="0" ${p.class==0?'selected':''}>TD</option>
          <option value="1" ${p.class==1?'selected':''}>TS</option>
          <option value="2" ${p.class==2?'selected':''}>Cat 1</option>
          <option value="3" ${p.class==3?'selected':''}>Cat 2</option>
          <option value="4" ${p.class==4?'selected':''}>Cat 3</option>
          <option value="5" ${p.class==5?'selected':''}>Cat 4</option>
          <option value="6" ${p.class==6?'selected':''}>Cat 5</option>
        </select><br>
        <button id="eBtnSave" style="margin-top:8px; width:100%">Save Changes</button>
        <details style="margin-top:6px;font-size:11px;">
          <summary>Categories</summary>
          <table class="ss-table">
            <tr><td>TD</td><td>&lt;33 kt</td></tr>
            <tr><td>TS</td><td>34-63 kt</td></tr>
            <tr><td>Cat 1</td><td>64-82 kt</td></tr>
            <tr><td>Cat 2</td><td>83-95 kt</td></tr>
            <tr><td>Cat 3</td><td>96-112 kt</td></tr>
            <tr><td>Cat 4</td><td>113-136 kt</td></tr>
            <tr><td>Cat 5</td><td>≥137 kt</td></tr>
          </table>
        </details>
      </div>`;

    if(EDIT_POPUP) map.closePopup();
    EDIT_POPUP = L.popup({maxWidth:280})
        .setLatLng([p.lat, p.long])
        .setContent(html)
        .openOn(map);

    setTimeout(() => {
      const btn = document.getElementById('eBtnSave');
      if(btn) btn.onclick = () => {
        storm.name = document.getElementById('eName').value.trim() || 'UNNAMED';
        p.time = document.getElementById('eTime').value.replace('T',' ');
        p.lat = parseFloat(document.getElementById('eLat').value);
        p.long = parseFloat(document.getElementById('eLong').value);
        p.speed = document.getElementById('eSpeed').value;
        p.pressure = document.getElementById('ePres').value;
        p.class = parseInt(document.getElementById('eClass').value);
        map.closePopup(); 
        EDIT_POPUP = null;
        renderStorm(storm, false);
      };
    }, 100);
  }

  /* =========================================================
     8.  FILE IMPORT
     ========================================================= */
  document.getElementById('file').addEventListener('change', ev => {
    [...ev.target.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const rawJSON = JSON.parse(e.target.result);
          const cleanStorms = normalizeStormData(rawJSON);
          if(cleanStorms.length === 0) {
            alert("No valid storm data found in " + file.name);
            return;
          }
          cleanStorms.forEach(st => {
            ALL_STORMS.push(st);
            renderStorm(st, false);
          });
        } catch(err) {
          alert(`Error reading ${file.name}:\n${err}`);
          console.error(err);
        }
      };
      reader.readAsText(file);
    });
  });

  /* =========================================================
     9.  UI CONTROLS
     ========================================================= */
  const $ = id => document.getElementById(id);
  $('sbStart').value = new Date().toISOString().slice(0,16);

  function fmtTime(epochS) {
    return new Date(epochS*1000).toISOString().replace('T',' ').slice(0,16);
  }

  function snap(v) { return Math.round(v*10)/10; }

  $('sbNew').onclick = () => {
    if(ACTIVE_DRAW && ACTIVE_DRAW.points.length) {
      const newStorm = {
        name: ACTIVE_DRAW.name,
        start_time: ACTIVE_DRAW.startEpoch,
        path: ACTIVE_DRAW.points.map(p => ({
          time: fmtTime(p.time),
          lat: p.lat,
          long: p.long,
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      };
      ALL_STORMS.push(newStorm);
      map.removeLayer(ACTIVE_DRAW.line);
      map.removeLayer(ACTIVE_DRAW.dots);
      renderStorm(newStorm, false);
    }

    const name = $('sbName').value.trim() || 'UNNAMED';
    const startEpoch = Math.floor(new Date($('sbStart').value).getTime()/1000);
    if(!startEpoch) { alert('Pick a valid start date/time'); return; }

    ACTIVE_DRAW = {
      name: name,
      startEpoch: startEpoch,
      points: [],
      line: L.polyline([], {color: '#ff7800', weight: 3}).addTo(map),
      dots: L.layerGroup().addTo(map)
    };
  };

  $('sbExport').onclick = () => {
    if(ACTIVE_DRAW && ACTIVE_DRAW.points.length) {
      const newStorm = {
        name: ACTIVE_DRAW.name,
        start_time: ACTIVE_DRAW.startEpoch,
        path: ACTIVE_DRAW.points.map(p => ({
          time: fmtTime(p.time),
          lat: p.lat,
          long: p.long,
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      };
      ALL_STORMS.push(newStorm);
      map.removeLayer(ACTIVE_DRAW.line);
      map.removeLayer(ACTIVE_DRAW.dots);
      renderStorm(newStorm, false);
      ACTIVE_DRAW = null;
    }

    if(!ALL_STORMS.length) { alert('No storms to export'); return; }

    const exportData = ALL_STORMS.map(s => ({
      name: s.name,
      start_time: s.start_time,
      path: s.path.map(p => ({
        time: p.time,
        lat: p.lat,
        long: p.long,
        speed: p.speed,
        pressure: p.pressure,
        class: p.class
      }))
    }));

    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const a = Object.assign(document.createElement('a'), {
      href: URL.createObjectURL(blob),
      download: 'myStorms.json'
    });
    document.body.appendChild(a); a.click(); a.remove();
  };

  // "Highlight All Tracks" toggles visual emphasis
  let HIGHLIGHT_MODE = false;
  $('editAllBtn').addEventListener('click', () => {
    HIGHLIGHT_MODE = !HIGHLIGHT_MODE;
    $('editAllBtn').classList.toggle('edit-mode', HIGHLIGHT_MODE);
    $('editAllBtn').textContent = HIGHLIGHT_MODE ? 'Normal View' : 'Highlight All Tracks';
    redrawAll(!HIGHLIGHT_MODE); // faint when not highlighted
  });

  // Lock Map
  $('lockMapBtn').addEventListener('click', toggleMapLock);

  /* =========================================================
     10. MAP CLICK (ADD POINT)
     ========================================================= */
  map.on('click', e => {
    if(!ACTIVE_DRAW) return;
    const lat = snap(e.latlng.lat);
    const long = snap(e.latlng.lng);
    const idx = ACTIVE_DRAW.points.length;
    const epoch = ACTIVE_DRAW.startEpoch + idx*6*3600 + Math.floor(idx/4)*18*3600;
    const prev = idx > 0 ? ACTIVE_DRAW.points[idx-1] : null;
    const defSpeed = prev ? prev.speed : '35';
    const defPres = prev ? prev.pressure : '1000';
    const defClass = prev ? prev.class : 1;
    const tempPoint = { lat, long, time: epoch, speed: defSpeed, pressure: defPres, class: defClass };

    const html = `
      <div style="font-size:13px; max-width:250px;">
        <b>Add New Point</b><br>
        Lat: ${lat}° Long: ${long}°<br>
        Speed (kt): <input id="pSpeed" type="number" value="${tempPoint.speed}" min="0" max="200" step="5"><br>
        Pressure (hPa): <input id="pPres" type="number" value="${tempPoint.pressure}" min="800" max="1030"><br>
        Class: 
        <select id="pClass">
          <option value="0" ${tempPoint.class==0?'selected':''}>TD</option>
          <option value="1" ${tempPoint.class==1?'selected':''}>TS</option>
          <option value="2" ${tempPoint.class==2?'selected':''}>Cat 1</option>
          <option value="3" ${tempPoint.class==3?'selected':''}>Cat 2</option>
          <option value="4" ${tempPoint.class==4?'selected':''}>Cat 3</option>
          <option value="5" ${tempPoint.class==5?'selected':''}>Cat 4</option>
          <option value="6" ${tempPoint.class==6?'selected':''}>Cat 5</option>
        </select><br>
        <button id="pOK" style="margin-top:8px; width:100%">Add Point</button>
        <details style="margin-top:6px;font-size:11px;">
          <summary>Categories</summary>
          <table class="ss-table">
            <tr><td>TD</td><td>&lt;33 kt</td></tr>
            <tr><td>TS</td><td>34-63 kt</td></tr>
            <tr><td>Cat 1</td><td>64-82 kt</td></tr>
            <tr><td>Cat 2</td><td>83-95 kt</td></tr>
            <tr><td>Cat 3</td><td>96-112 kt</td></tr>
            <tr><td>Cat 4</td><td>113-136 kt</td></tr>
            <tr><td>Cat 5</td><td>≥137 kt</td></tr>
          </table>
        </details>
      </div>`;

    L.popup({autoClose: false, closeOnClick: false})
      .setLatLng(e.latlng)
      .setContent(html)
      .openOn(map);

    setTimeout(() => {
      const btn = document.getElementById('pOK');
      if(btn) {
        btn.onclick = () => {
          tempPoint.speed = document.getElementById('pSpeed').value;
          tempPoint.pressure = document.getElementById('pPres').value;
          tempPoint.class = parseInt(document.getElementById('pClass').value);
          ACTIVE_DRAW.points.push(tempPoint);
          ACTIVE_DRAW.line.addLatLng([lat, long]);
          L.marker([lat, long], {
            icon: L.divIcon({ className: 'sb-marker', html: idx+1, iconSize: [16,16] })
          }).addTo(ACTIVE_DRAW.dots);
          map.closePopup();
        };
      }
    }, 100);
  });

  /* =========================================================
     11. DRAG CURSOR
     ========================================================= */
  const style = document.createElement('style');
  style.textContent = `
    .leaflet-container .storm-point {
      cursor: grab !important;
    }
    .leaflet-container .storm-point.leaflet-dragging {
      cursor: grabbing !important;
    }
    .first-point {
      stroke: #000 !important;
      stroke-width: 2px !important;
    }
  `;
  document.head.appendChild(style);
  </script>
</body>
</html>
