<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hypo-Track Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,body{margin:0;height:100%}
    #map{height:100%;width:100%}
    /* ---- storm-builder panel ---- */
    #stormBuilder{
      position:absolute;
      top:70px;
      right:10px;
      z-index:1000;
      background:rgba(255,255,255,.9);
      padding:8px;
      border-radius:4px;
      box-shadow:0 1px 5px rgba(0,0,0,.4);
      font-size:13px;
      width:200px;
    }
    #stormBuilder input, #stormBuilder button{
      width:100%;
      margin:4px 0;
      box-sizing:border-box;
    }
    .sb-marker{
      background:#ff7800;
      color:#fff;
      border-radius:50%;
      border:1px solid #fff;
      text-align:center;
      line-height:14px;
      font-size:10px;
      font-weight:bold;
    }
    /* saffir table in popup */
    .ss-table{font-size:11px;border-collapse:collapse;margin-top:4px}
    .ss-table td{border:1px solid #ccc;padding:2px 4px}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ---- control panel ---- -->
  <div id="stormBuilder">
    <input id="sbName" placeholder="Storm name" value="MYSTORM">
    <input id="sbStart" type="datetime-local" step="1">
    <button id="sbNew">New storm</button>
    <button id="sbExport" disabled>Export JSON</button>
    <div id="sbHint" style="font-size:11px;color:#666;margin-top:4px">
      Click “New storm”, then click map to add points.<br>
      <b>4 clicks = 1 day</b>
    </div>
  </div>

  <script>
  /* =========================================================
     1.  ORIGINAL VIEWER CODE (minimalised)
     ========================================================= */
  const map = L.map('map').setView([15, 135], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OSM contributors'
  }).addTo(map);

  let shownLayer = L.layerGroup().addTo(map);

  /* quick colour per class */
  function classColor(c){
    return ['#888','#ffd800','#ff7800','#ff3800','#c80000','#8c00ff'][c]||'#888';
  }

  /* draw one storm */
  function drawStorm(storm){
    const pts = storm.path;
    const line = L.polyline(pts.map(p=>[p.lat,p.long]), {
      color: classColor(pts[pts.length-1].class),
      weight: 3
    });
    const dots = L.layerGroup();
    pts.forEach((p,i)=>{
      L.circleMarker([p.lat,p.long],{
        radius: 5,
        color: classColor(p.class),
        fillOpacity: 1
      }).bindPopup(`<b>${storm.name}</b><br>${p.time}<br>${p.speed} kt / ${p.pressure} hPa`).addTo(dots);
    });
    shownLayer.addLayer(L.layerGroup([line,dots]));
  }

  /* demo: load wp_2020_data.json if it exists */
  fetch('wp_2020_data.json')
    .then(r=>r.json())
    .then(arr=> arr.forEach(drawStorm))
    .catch(()=>console.log('wp_2020_data.json not found – draw your own storm'));

  /* =========================================================
     2.  STORM-BUILDER ADD-ON
     ========================================================= */
  let sbActive=false, sbPath=[], sbStartEpoch, sbName, sbLine;
  const sbMarkers = L.layerGroup().addTo(map);
  const $=id=>document.getElementById(id);
  $('sbStart').value=new Date().toISOString().slice(0,16);

  function snap(v){return Math.round(v*10)/10;}
  function fmtTime(epochS){
    return new Date(epochS*1000).toISOString().replace('T',' ').slice(0,16);
  }

  /* saffir-simpson lookup (knots → category) */
  function saffir(knots){
    if(knots<33)return 0;
    if(knots<=63)return 1;
    if(knots<=82)return 2;
    if(knots<=95)return 3;
    if(knots<=112)return 4;
    if(knots<=136)return 5;
    return 6; // 137+
  }
  const ssTable=`
    <table class="ss-table">
      <tr><td>TD</td><td>&lt;33 kt</td></tr>
      <tr><td>TS</td><td>34-63 kt</td></tr>
      <tr><td>Cat 1</td><td>64-82 kt</td></tr>
      <tr><td>Cat 2</td><td>83-95 kt</td></tr>
      <tr><td>Cat 3</td><td>96-112 kt</td></tr>
      <tr><td>Cat 4</td><td>113-136 kt</td></tr>
      <tr><td>Cat 5</td><td>≥137 kt</td></tr>
    </table>`;

  /* ---- panel buttons ---- */
  $('sbNew').onclick=()=>{
    sbName=$('sbName').value.trim()||'UNNAMED';
    sbStartEpoch=Math.floor(new Date($('sbStart').value).getTime()/1000);
    if(!sbStartEpoch){alert('Pick a valid start date/time');return;}
    sbPath=[]; sbMarkers.clearLayers();
    if(sbLine)map.removeLayer(sbLine);
    sbLine=L.polyline([],{color:'#ff7800',weight:3}).addTo(map);
    sbActive=true;
    $('sbExport').disabled=false;
    $('sbHint').textContent='Click map to add points (4 clicks = 1 day).';
  };

  $('sbExport').onclick=()=>{
    if(!sbPath.length){alert('No points added yet');return;}
    const obj={
      name:sbName.toUpperCase(),
      start_time:sbStartEpoch,
      path:sbPath.map(p=>({
        time:fmtTime(p.time),
        lat:p.lat,
        long:p.lon,
        speed:p.speed,
        pressure:p.pressure,
        class:p.class
      }))
    };
    const blob=new Blob([JSON.stringify([obj],null,2)],{type:'application/json'});
    const a=Object.assign(document.createElement('a'),{
      href:URL.createObjectURL(blob),
      download:(sbName.toLowerCase()||'storm')+'.json'
    });
    document.body.appendChild(a); a.click(); a.remove();
  };

  /* ---- map clicks ---- */
  map.on('click',e=>{
    if(!sbActive)return;
    const lat=snap(e.latlng.lat), lon=snap(e.latlng.lng);
    const idx=sbPath.length;
    // 4 points = 1 day → jump 24 h instead of 6 h
    const epoch=sbStartEpoch + idx*6*3600 + Math.floor(idx/4)*18*3600;

    const point={
      lat:lat, lon:lon, time:epoch,
      speed:idx?sbPath[idx-1].speed:'35',
      pressure:idx?sbPath[idx-1].pressure:'1000',
      class:idx?sbPath[idx-1].class:1
    };

    const popup=L.popup({autoClose:false,closeOnClick:false})
      .setLatLng(e.latlng)
      .setContent(`
        <div style="font-size:13px">
          Lat:${lat}° Lon:${lon}°<br>
          Speed(kt):<input id="pSpeed" type="number" value="${point.speed}" min="0" max="200" step="5"><br>
          Pressure(hPa):<input id="pPres" type="number" value="${point.pressure}" min="800" max="1020"><br>
          Class:<select id="pClass">
            <option value="0" ${point.class===0?'selected':''}>Disturbance</option>
            <option value="1" ${point.class===1?'selected':''}>TD/TS</option>
            <option value="2" ${point.class===2?'selected':''}>Cat 1</option>
            <option value="3" ${point.class===3?'selected':''}>Cat 2</option>
            <option value="4" ${point.class===4?'selected':''}>Cat 3</option>
            <option value="5" ${point.class===5?'selected':''}>Cat 4</option>
            <option value="6" ${point.class===6?'selected':''}>Cat 5</option>
          </select><br>
          <button id="pOK">OK</button>
          ${ssTable}
        </div>`)
      .openOn(map);

    document.getElementById('pOK').onclick=()=>{
      point.speed=document.getElementById('pSpeed').value;
      point.pressure=document.getElementById('pPres').value;
      point.class=parseInt(document.getElementById('pClass').value);
      sbPath.push(point);
      sbLine.addLatLng([lat,lon]);
      L.marker([lat,lon],{icon:L.divIcon({className:'sb-marker',html:idx||'',iconSize:[14,14]})}).addTo(sbMarkers);
      map.closePopup();
    };
  });
  </script>
</body>
</html>
