<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hypo-Track Maker / Loader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,body{margin:0;height:100%}
    #map{height:100%;width:100%}
    #panel{
      position:absolute;
      top:70px;
      right:10px;
      z-index:1000;
      background:rgba(255,255,255,.9);
      padding:8px;
      border-radius:4px;
      box-shadow:0 1px 5px rgba(0,0,0,.4);
      font-size:13px;
      width:200px;
    }
    #panel input, #panel button, #panel select{
      width:100%;
      margin:4px 0;
      box-sizing:border-box;
    }
    .sb-marker{
      background:#ff7800;
      color:#fff;
      border-radius:50%;
      border:1px solid #fff;
      text-align:center;
      line-height:14px;
      font-size:10px;
      font-weight:bold;
    }
    .ss-table{font-size:11px;border-collapse:collapse;margin-top:4px}
    .ss-table td{border:1px solid #ccc;padding:2px 4px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <input id="file" type="file" accept=".json" multiple title="Import JSON(s)">
    <input id="sbName" placeholder="Storm name" value="MYSTORM">
    <input id="sbStart" type="datetime-local" step="1">
    <button id="sbNew">New storm</button>
    <button id="sbExport">Export ALL storms</button>
    <div id="hint" style="font-size:11px;color:#666;margin-top:4px">
      1. Import or draw.<br>2. Click any point to edit.<br>3. Export when done.
    </div>
  </div>

  <script>
  /* =========================================================
     1.  BASE MAP
     ========================================================= */
  const map = L.map('map').setView([15, 135], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OSM contributors'
  }).addTo(map);

  /* =========================================================
     2.  GLOBAL STATE
     ========================================================= */
  const ALL_STORMS = [];   // raw json only: {name, start_time, path[]}
  let ACTIVE_DRAW = null;  // {name, startEpoch, points[], line, dots}
  let EDIT_POPUP = null;

  /* =========================================================
     3.  DRAW HELPERS
     ========================================================= */
  function classColor(c){
    return ['#888','#ffd800','#ff7800','#ff3800','#c80000','#8c00ff'][c]||'#888';
  }
  function saffir(k){
    if(k<33)return 0; if(k<=63)return 1; if(k<=82)return 2;
    if(k<=95)return 3; if(k<=112)return 4; if(k<=136)return 5; return 6;
  }
  const ssTable=`
    <table class="ss-table">
      <tr><td>TD</td><td>&lt;33 kt</td></tr>
      <tr><td>TS</td><td>34-63 kt</td></tr>
      <tr><td>Cat 1</td><td>64-82 kt</td></tr>
      <tr><td>Cat 2</td><td>83-95 kt</td></tr>
      <tr><td>Cat 3</td><td>96-112 kt</td></tr>
      <tr><td>Cat 4</td><td>113-136 kt</td></tr>
      <tr><td>Cat 5</td><td>≥137 kt</td></tr>
    </table>`;

  /* render one storm (faint if not active) */
  function renderStorm(storm, faint){
    const pts = storm.path;
    const line = L.polyline(pts.map(p=>[p.lat,p.lon]), {
      color: classColor(pts[pts.length-1].class),
      weight: 3,
      opacity: faint ? 0.35 : 1
    });
    const dots = L.layerGroup();
    pts.forEach((p,i)=>{
      const m = L.circleMarker([p.lat,p.lon],{
        radius: 5,
        color: classColor(p.class),
        fillOpacity: 1,
        opacity: faint ? 0.35 : 1
      });
      m.on('click',()=>openPointEditor(storm,i));
      m.bindPopup(`<b>${storm.name}</b> #${i+1}<br>${p.time}<br>${p.speed} kt / ${p.pressure} hPa`);
      dots.addLayer(m);
    });
    const layer = L.layerGroup([line,dots]);
    layer.addTo(map);
    storm._layer = layer;   // store for removal
  }
  function redrawAllFaint(){
    ALL_STORMS.forEach(s=>{
      if(s._layer) map.removeLayer(s._layer);
      renderStorm(s, true);
    });
  }

  /* =========================================================
     4.  POINT EDITOR
     ========================================================= */
  window.openPointEditor = function(stormIdx, ptIdx){
    const storm = ALL_STORMS[stormIdx];
    const p = storm.path[ptIdx];
    const html=`
      <div style="font-size:13px">
        <b>Edit point</b><br>
        Storm name:<input id="eName" value="${storm.name}"><br>
        Date/time:<input id="eTime" type="datetime-local" value="${p.time.replace(' ','T')}"><br>
        Lat:<input id="eLat" type="number" step="0.1" value="${p.lat}"><br>
        Lon:<input id="eLon" type="number" step="0.1" value="${p.lon}"><br>
        Speed(kt):<input id="eSpeed" type="number" min="0" max="200" value="${p.speed}"><br>
        Pressure(hPa):<input id="ePres" type="number" min="800" max="1030" value="${p.pressure}"><br>
        Class:<select id="eClass">${[0,1,2,3,4,5,6].map(c=>`<option value="${c}" ${p.class==c?'selected':''}>${c}</option>`).join('')}</select><br>
        <button onclick="savePointEdit(${stormIdx},${ptIdx})">Save</button>
        ${ssTable}
      </div>`;
    if(EDIT_POPUP) map.closePopup();
    EDIT_POPUP = L.popup({maxWidth:250}).setLatLng([p.lat,p.lon]).setContent(html).openOn(map);
  };
  window.savePointEdit = function(stormIdx, ptIdx){
    const storm = ALL_STORMS[stormIdx];
    const p = storm.path[ptIdx];
    storm.name = document.getElementById('eName').value.trim()||'UNNAMED';
    p.time = document.getElementById('eTime').value.replace('T',' ');
    p.lat = parseFloat(document.getElementById('eLat').value)||0;
    p.lon = parseFloat(document.getElementById('eLon').value)||0;
    p.speed = document.getElementById('eSpeed').value;
    p.pressure = document.getElementById('ePres').value;
    p.class = parseInt(document.getElementById('eClass').value);
    map.closePopup(); EDIT_POPUP=null;
    if(storm._layer) map.removeLayer(storm._layer);
    renderStorm(storm, ACTIVE_DRAW && storm!==ACTIVE_DRAW);
  };

  /* =========================================================
     5.  FILE IMPORT
     ========================================================= */
  document.getElementById('file').addEventListener('change', ev=>{
    [...ev.target.files].forEach(file=>{
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const arr = JSON.parse(e.target.result);
          if(!Array.isArray(arr)) throw "JSON is not an array";
        arr.forEach(st => {
  if (!st.name || !st.path) throw "Bad storm object";

  // Clean path: fix keys and filter out invalid coords
  st.path = st.path.filter(p => {
    // Normalize longitude key
    if ('long' in p && !('lon' in p)) {
      p.lon = p.long;
      delete p.long;
    }

    // Ensure lat/lon are valid numbers
    const lat = parseFloat(p.lat);
    const lon = parseFloat(p.lon);

    if (isNaN(lat) || isNaN(lon)) {
      console.warn(`Skipping invalid point in ${st.name}: lat=${p.lat}, lon=${p.lon}`);
      return false;
    }

    p.lat = lat;
    p.lon = lon;
    return true;
  });

  if (st.path.length === 0) {
    console.warn(`Storm ${st.name} has no valid points — skipped.`);
    return;
  }

  ALL_STORMS.push(st);
  renderStorm(st, false);
});
        }catch(err){alert(`Error reading ${file.name}:\n${err}`);}
      };
      reader.readAsText(file);
    });
  });

  /* =========================================================
     6.  NEW-STORM DRAWING
     ========================================================= */
  const $=id=>document.getElementById(id);
  $('sbStart').value=new Date().toISOString().slice(0,16);

  $('sbNew').onclick=()=>{
    // finish previous draw if any
    if(ACTIVE_DRAW && ACTIVE_DRAW.points.length){
      ALL_STORMS.push({
        name: ACTIVE_DRAW.name,
        start_time: ACTIVE_DRAW.startEpoch,
        path: ACTIVE_DRAW.points.map(p=>({
          time: fmtTime(p.time),
          lat: p.lat,
          lon: p.lon,
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      });
      map.removeLayer(ACTIVE_DRAW.line);
      map.removeLayer(ACTIVE_DRAW.dots);
    }
    const name=$('sbName').value.trim()||'UNNAMED';
    const startEpoch=Math.floor(new Date($('sbStart').value).getTime()/1000);
    if(!startEpoch){alert('Pick a valid start date/time');return;}
    ACTIVE_DRAW={
      name:name,
      startEpoch:startEpoch,
      points:[],
      line:L.polyline([],{color:'#ff7800',weight:3}).addTo(map),
      dots:L.layerGroup().addTo(map)
    };
    redrawAllFaint();
  };

  /* =========================================================
     7.  EXPORT EVERYTHING
     ========================================================= */
  $('sbExport').onclick=()=>{
    // finish active draw
    if(ACTIVE_DRAW && ACTIVE_DRAW.points.length){
      ALL_STORMS.push({
        name: ACTIVE_DRAW.name,
        start_time: ACTIVE_DRAW.startEpoch,
        path: ACTIVE_DRAW.points.map(p=>({
          time: fmtTime(p.time),
          lat: p.lat,
          lon: p.lon,
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      });
      map.removeLayer(ACTIVE_DRAW.line);
      map.removeLayer(ACTIVE_DRAW.dots);
      ACTIVE_DRAW=null;
    }
    if(!ALL_STORMS.length){alert('No storms to export');return;}
    const exportData = ALL_STORMS.map(s=>({name:s.name, start_time:s.start_time, path:s.path}));
    const blob=new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});
    const a=Object.assign(document.createElement('a'),{
      href:URL.createObjectURL(blob),
      download:'myStorms.json'
    });
    document.body.appendChild(a); a.click(); a.remove();
  };

  /* =========================================================
     8.  DRAW CLICK HANDLER
     ========================================================= */
  function fmtTime(epochS){
    return new Date(epochS*1000).toISOString().replace('T',' ').slice(0,16);
  }
  function snap(v){return Math.round(v*10)/10;}

  map.on('click',e=>{
    if(!ACTIVE_DRAW)return;
    const lat=snap(e.latlng.lat);
    const lon=snap(e.latlng.lng);
    if(isNaN(lat)||isNaN(lon))return; // guard
    const idx=ACTIVE_DRAW.points.length;
    // 4 points = 1 day → 24 h jump
    const epoch=ACTIVE_DRAW.startEpoch + idx*6*3600 + Math.floor(idx/4)*18*3600;

    const point={
      lat:lat, lon:lon, time:epoch,
      speed:idx?ACTIVE_DRAW.points[idx-1].speed:'35',
      pressure:idx?ACTIVE_DRAW.points[idx-1].pressure:'1000',
      class:idx?ACTIVE_DRAW.points[idx-1].class:1
    };

    const html=`
      <div style="font-size:13px">
        Lat:${lat}° Lon:${lon}°<br>
        Speed(kt):<input id="pSpeed" type="number" value="${point.speed}" min="0" max="200" step="5"><br>
        Pressure(hPa):<input id="pPres" type="number" value="${point.pressure}" min="800" max="1030"><br>
        Class:<select id="pClass">${[0,1,2,3,4,5,6].map(c=>`<option value="${c}" ${point.class==c?'selected':''}>${c}</option>`).join('')}</select><br>
        <button id="pOK">OK</button>
        ${ssTable}
      </div>`;

    L.popup({autoClose:false,closeOnClick:false})
      .setLatLng(e.latlng)
      .setContent(html)
      .openOn(map);

    document.getElementById('pOK').onclick=()=>{
      point.speed=document.getElementById('pSpeed').value;
      point.pressure=document.getElementById('pPres').value;
      point.class=parseInt(document.getElementById('pClass').value);
      ACTIVE_DRAW.points.push(point);
      ACTIVE_DRAW.line.addLatLng([lat,lon]);
      L.marker([lat,lon],{icon:L.divIcon({className:'sb-marker',html:idx||'',iconSize:[14,14]})}).addTo(ACTIVE_DRAW.dots);
      map.closePopup();
    };
  });
  </script>
</body>
</html>
