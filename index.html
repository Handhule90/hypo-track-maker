<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hypo-Track Maker / Loader (long-based)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,body{margin:0;height:100%}
    #map{height:100%;width:100%}
    #panel{
      position:absolute;top:70px;right:10px;z-index:1000;
      background:rgba(255,255,255,.9);padding:8px;border-radius:4px;
      box-shadow:0 1px 5px rgba(0,0,0,.4);font-size:13px;width:200px;
    }
    #panel input,#panel button,#panel select{width:100%;margin:4px 0;box-sizing:border-box}
    .sb-marker{background:#ff7800;color:#fff;border-radius:50%;border:1px solid #fff;
               text-align:center;line-height:14px;font-size:10px;font-weight:bold}
    .ss-table{font-size:11px;border-collapse:collapse;margin-top:4px}
    .ss-table td{border:1px solid #ccc;padding:2px 4px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <input id="file" type="file" accept=".json" multiple title="Import JSON(s)">
    <input id="sbName" placeholder="Storm name" value="MYSTORM">
    <input id="sbStart" type="datetime-local" step="1">
    <button id="sbNew">New storm</button>
    <button id="sbExport">Export ALL storms</button>
    <div id="hint" style="font-size:11px;color:#666;margin-top:4px">
      1. Import or draw.<br>2. Click any point to edit.<br>3. Export when done.
    </div>
  </div>

  <script>
  /* =========================================================
     1.  BASE MAP
     ========================================================= */
  const map = L.map('map').setView([15, 135], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OSM contributors'
  }).addTo(map);

  /* =========================================================
     2.  GLOBAL STATE
     ========================================================= */
  const ALL_STORMS = [];   // {name, start_time, path[{lat, long, ...}]}
  let ACTIVE_DRAW = null;
  let EDIT_POPUP = null;

  /* =========================================================
     3.  DATA NORMALISER  (accepts lon/lng/longitude → writes long)
     ========================================================= */
  function normalizeStormData(arr) {
    if (!Array.isArray(arr)) throw new Error("JSON must be an array of storms");
    return arr.map(storm => {
        if (!storm.path || !Array.isArray(storm.path)) return null;
        const validPath = storm.path.map(p => {
            let lat = parseFloat(p.lat ?? p.latitude);
            let long = parseFloat(p.long ?? p.lon ?? p.lng ?? p.longitude);
            if (isNaN(lat) || isNaN(long)) { console.warn("Bad point", p); return null; }
            return {
                time: p.time ?? "",
                lat: lat,
                long: long,               // <-- internal key is now 'long'
                speed: p.speed ?? 0,
                pressure: p.pressure ?? 1000,
                class: p.class ?? 0
            };
        }).filter(Boolean);
        if (!validPath.length) return null;
        return { name: storm.name || "UNNAMED", start_time: storm.start_time, path: validPath };
    }).filter(Boolean);
  }

  /* =========================================================
     4.  DRAW HELPERS
     ========================================================= */
  function classColor(c){
    return ['#888','#ffd800','#ff7800','#ff3800','#c80000','#8c00ff'][c]||'#888';
  }
  const ssTable=`
    <table class="ss-table">
      <tr><td>TD</td><td>&lt;33 kt</td></tr>
      <tr><td>TS</td><td>34-63 kt</td></tr>
      <tr><td>Cat 1</td><td>64-82 kt</td></tr>
      <tr><td>Cat 2</td><td>83-95 kt</td></tr>
      <tr><td>Cat 3</td><td>96-112 kt</td></tr>
      <tr><td>Cat 4</td><td>113-136 kt</td></tr>
      <tr><td>Cat 5</td><td>≥137 kt</td></tr>
    </table>`;

  function renderStorm(storm, faint){
    const pts = storm.path;
    const lineCoords = pts.map(p => [p.lat, p.long]);   // Leaflet wants [lat,long]
    const line = L.polyline(lineCoords, {
      color: classColor(pts[pts.length-1].class), weight: 3, opacity: faint ? 0.35 : 1
    });
    const dots = L.layerGroup();
    pts.forEach((p,i)=>{
      const m = L.circleMarker([p.lat, p.long], {
        radius: 5, color: classColor(p.class), fillOpacity: 1, opacity: faint ? 0.35 : 1
      });
      m.on('click', e => { L.DomEvent.stopPropagation(e); openPointEditor(storm, i); });
      m.bindPopup(`<b>${storm.name}</b> #${i+1}<br>${p.time}<br>${p.speed} kt / ${p.pressure} hPa`);
      dots.addLayer(m);
    });
    const layer = L.layerGroup([line,dots]);
    layer.addTo(map);
    storm._layer = layer;
  }
  function redrawAllFaint(){
    ALL_STORMS.forEach(s=>{ if(s._layer) map.removeLayer(s._layer); renderStorm(s, true); });
  }

  /* =========================================================
     5.  POINT EDITOR
     ========================================================= */
  window.openPointEditor = function(storm, ptIdx){
    const p = storm.path[ptIdx];
    let valTime = "";
    try { 
        let d = new Date(p.time);
        if(isNaN(d.getTime())) d = new Date(p.time.replace(' ', 'T')); 
        valTime = d.toISOString().slice(0,16); 
    } catch(e){}
    const html=`
      <div style="font-size:13px">
        <b>Edit point</b><br>
        Storm name:<input id="eName" value="${storm.name}"><br>
        Date/time:<input id="eTime" type="datetime-local" value="${valTime}"><br>
        Lat:<input id="eLat" type="number" step="0.1" value="${p.lat}"><br>
        Long:<input id="eLong" type="number" step="0.1" value="${p.long}"><br>
        Speed(kt):<input id="eSpeed" type="number" min="0" max="200" value="${p.speed}"><br>
        Pressure(hPa):<input id="ePres" type="number" min="800" max="1030" value="${p.pressure}"><br>
        Class:<select id="eClass">${[0,1,2,3,4,5,6].map(c=>`<option value="${c}" ${p.class==c?'selected':''}>${c}</option>`).join('')}</select><br>
        <button id="eBtnSave">Save</button>
        ${ssTable}
      </div>`;
    if(EDIT_POPUP) map.closePopup();
    EDIT_POPUP = L.popup({maxWidth:250})
        .setLatLng([p.lat, p.long])
        .setContent(html)
        .openOn(map);
    setTimeout(()=>{
        const btn = document.getElementById('eBtnSave');
        if(btn) btn.onclick = () => {
            storm.name = document.getElementById('eName').value.trim()||'UNNAMED';
            p.time = document.getElementById('eTime').value.replace('T',' ');
            p.lat = parseFloat(document.getElementById('eLat').value);
            p.long = parseFloat(document.getElementById('eLong').value);  // <-- long
            p.speed = document.getElementById('eSpeed').value;
            p.pressure = document.getElementById('ePres').value;
            p.class = parseInt(document.getElementById('eClass').value);
            map.closePopup(); EDIT_POPUP=null;
            if(storm._layer) map.removeLayer(storm._layer);
            renderStorm(storm, ACTIVE_DRAW && storm!==ACTIVE_DRAW);
        };
    }, 100);
  };

  /* =========================================================
     6.  FILE IMPORT
     ========================================================= */
  document.getElementById('file').addEventListener('change', ev=>{
    [...ev.target.files].forEach(file=>{
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const rawJSON = JSON.parse(e.target.result);
          const cleanStorms = normalizeStormData(rawJSON);
          if(cleanStorms.length === 0) {
              alert("No valid storm data found in " + file.name + "\nCheck console for details.");
              return;
          }
          cleanStorms.forEach(st => { ALL_STORMS.push(st); renderStorm(st, false); });
        } catch(err){ alert(`Error reading ${file.name}:\n${err}`); console.error(err); }
      };
      reader.readAsText(file);
    });
  });

  /* =========================================================
     7.  NEW-STORM DRAWING & EXPORT
     ========================================================= */
  const $=id=>document.getElementById(id);
  $('sbStart').value=new Date().toISOString().slice(0,16);
  function fmtTime(epochS){
    return new Date(epochS*1000).toISOString().replace('T',' ').slice(0,16);
  }
  function snap(v){return Math.round(v*10)/10;}

  $('sbNew').onclick=()=>{
    if(ACTIVE_DRAW && ACTIVE_DRAW.points.length){
      ALL_STORMS.push({
        name: ACTIVE_DRAW.name,
        start_time: ACTIVE_DRAW.startEpoch,
        path: ACTIVE_DRAW.points.map(p=>({
          time: fmtTime(p.time),
          lat: p.lat,
          long: p.long,                       // <-- long
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      });
      map.removeLayer(ACTIVE_DRAW.line);
      map.removeLayer(ACTIVE_DRAW.dots);
    }
    const name=$('sbName').value.trim()||'UNNAMED';
    const startEpoch=Math.floor(new Date($('sbStart').value).getTime()/1000);
    if(!startEpoch){alert('Pick a valid start date/time');return;}
    ACTIVE_DRAW={
      name:name,
      startEpoch:startEpoch,
      points:[],
      line:L.polyline([],{color:'#ff7800',weight:3}).addTo(map),
      dots:L.layerGroup().addTo(map)
    };
    redrawAllFaint();
  };

  $('sbExport').onclick=()=>{
    if(ACTIVE_DRAW && ACTIVE_DRAW.points.length){
      ALL_STORMS.push({
        name: ACTIVE_DRAW.name,
        start_time: ACTIVE_DRAW.startEpoch,
        path: ACTIVE_DRAW.points.map(p=>({
          time: fmtTime(p.time),
          lat: p.lat,
          long: p.long,                       // <-- long
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      });
      map.removeLayer(ACTIVE_DRAW.line);
      map.removeLayer(ACTIVE_DRAW.dots);
      ACTIVE_DRAW=null;
    }
    if(!ALL_STORMS.length){alert('No storms to export');return;}
    const exportData = ALL_STORMS.map(s=>({
        name: s.name,
        start_time: s.start_time,
        path: s.path.map(p => ({
            time: p.time,
            lat: p.lat,
            long: p.long,                   // <-- long
            speed: p.speed,
            pressure: p.pressure,
            class: p.class
        }))
    }));
    const blob=new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});
    const a=Object.assign(document.createElement('a'),{
      href:URL.createObjectURL(blob),
      download:'myStorms.json'
    });
    document.body.appendChild(a); a.click(); a.remove();
  };

  /* =========================================================
     8.  MAP CLICK (ADD POINT)
     ========================================================= */
  map.on('click',e=>{
    if(!ACTIVE_DRAW)return;
    const lat=snap(e.latlng.lat);
    const long=snap(e.latlng.lng);                // <-- long
    const idx=ACTIVE_DRAW.points.length;
    const epoch=ACTIVE_DRAW.startEpoch + idx*6*3600 + Math.floor(idx/4)*18*3600;
    const prev = idx > 0 ? ACTIVE_DRAW.points[idx-1] : null;
    const defSpeed = prev ? prev.speed : '35';
    const defPres  = prev ? prev.pressure : '1000';
    const defClass = prev ? prev.class : 1;
    const tempPoint = {
      lat:lat, long:long, time:epoch,
      speed: defSpeed, pressure: defPres, class: defClass
    };
    const html=`
      <div style="font-size:13px">
        Lat:${lat}° Long:${long}°<br>
        Speed(kt):<input id="pSpeed" type="number" value="${tempPoint.speed}" min="0" max="200" step="5"><br>
        Pressure(hPa):<input id="pPres" type="number" value="${tempPoint.pressure}" min="800" max="1030"><br>
        Class:<select id="pClass">${[0,1,2,3,4,5,6].map(c=>`<option value="${c}" ${tempPoint.class==c?'selected':''}>${c}</option>`).join('')}</select><br>
        <button id="pOK">OK</button>
        ${ssTable}
      </div>`;
    L.popup({autoClose:false,closeOnClick:false})
      .setLatLng(e.latlng)
      .setContent(html)
      .openOn(map);
    setTimeout(() => {
        const btn = document.getElementById('pOK');
        if(btn) {
            btn.onclick=()=>{
              tempPoint.speed=document.getElementById('pSpeed').value;
              tempPoint.pressure=document.getElementById('pPres').value;
              tempPoint.class=parseInt(document.getElementById('pClass').value);
              ACTIVE_DRAW.points.push(tempPoint);
              ACTIVE_DRAW.line.addLatLng([lat,long]);
              L.marker([lat,long],{
                  icon:L.divIcon({className:'sb-marker',html:idx+1,iconSize:[16,16]})
              }).addTo(ACTIVE_DRAW.dots);
              map.closePopup();
            };
        }
    }, 100);
  });
  </script>
</body>
</html>
