<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Hypo-Track â€“ Storm Builder</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body{font-family:system-ui, sans-serif; margin:2rem}
    label{display:block;margin:.5rem 0 .2rem}
    input,select{width:100%;max-width:20rem}
    button{margin:.3rem .3rem 0 0}
    #paths{max-width:40rem}
    .point{background:#f5f5f5;border:1px solid #ccc;padding:.5rem;margin:.3rem 0;border-radius:4px}
  </style>
</head>
<body>
  <h1>Storm Builder</h1>

  <label>Storm name
    <input id="name" placeholder="e.g. MYSTORM">
  </label>

  <label>Start date (UTC)
    <input id="date" type="datetime-local"/>
  </label>

  <h2>Track points</h2>
  <div id="paths"></div>
  <button id="addPoint">+ Add point</button>

  <br><br>
  <button id="export">Export JSON</button>
  <button id="import">Import JSON</button>
  <input id="fileIn" type="file" accept=".json" style="display:none"/>

  <a href="storm-builder.html">Storm Builder</a>

  <script>
    const $ = id => document.getElementById(id);
    let points = [];

    function render(){
      $('paths').innerHTML = points.map((p,i)=>`
        <div class="point">
          <label>Time (UTC)
            <input type="datetime-local" value="${p.time}" onchange="points[${i}].time=this.value">
          </label>
          <label>Lat
            <input type="number" step="0.1" value="${p.lat}" onchange="points[${i}].lat=+this.value">
          </label>
          <label>Lon
            <input type="number" step="0.1" value="${p.lon}" onchange="points[${i}].lon=+this.value">
          </label>
          <label>Speed (kt)
            <input type="text" value="${p.speed}" onchange="points[${i}].speed=this.value">
          </label>
          <label>Pressure (hPa)
            <input type="text" value="${p.pressure}" onchange="points[${i}].pressure=this.value">
          </label>
          <label>Class
            <select onchange="points[${i}].class=+this.value">
              <option value="0" ${p.class===0?'selected':''}>TD</option>
              <option value="1" ${p.class===1?'selected':''}>TS</option>
              <option value="2" ${p.class===2?'selected':''}>Cat 1-2</option>
              <option value="3" ${p.class===3?'selected':''}>Cat 3-4</option>
              <option value="4" ${p.class===4?'selected':''}>Cat 5</option>
            </select>
          </label>
          <button onclick="points.splice(${i},1);render()">Remove</button>
        </div>`).join('');
    }
    $('addPoint').onclick = ()=>{
      points.push({time:'',lat:15.0,lon:130.0,speed:'35',pressure:'1000',class:1});
      render();
    };
    $('export').onclick = ()=>{
      if(!$('name').value || !$('date').value || !points.length){
        return alert('Fill name, start date and at least one point.');
      }
      const unix = Math.round(new Date($('date').value).getTime()/1000);
      const out = [{
        name: $('name').value.toUpperCase(),
        start_time: unix,
        path: points.map(p=>({
          time: p.time.replace('T',' ')+':00',
          lat: p.lat,
          long: p.lon,
          speed: p.speed,
          pressure: p.pressure,
          class: p.class
        }))
      }];
      const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'custom_storms.json';
      a.click();
    };
    $('import').onclick = ()=>$('fileIn').click();
    $('fileIn').onchange = e=>{
      const file = e.target.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const arr = JSON.parse(r.result);
          if(!Array.isArray(arr) || !arr[0].name) throw 0;
          $('name').value = arr[0].name;
          $('date').value = new Date(arr[0].start_time*1000).toISOString().slice(0,16);
          points = arr[0].path.map(p=>({
            time: p.time.replace(' ','T').slice(0,16),
            lat: p.lat, lon: p.long,
            speed: p.speed, pressure: p.pressure, class: p.class
          }));
          render();
        }catch{ alert('Invalid file.'); }
      };
      r.readAsText(file);
    };
    render();
  </script>
</body>
</html>
